## 背景

针对游戏业务，修改Cpython解释器相关模块，实现多线程程序中，主线程跳出死循环。



## 实现方式

1、Python while 循环和 for 循环的字节码表示中，都有一个共同的 op_code：JUMP_ABSOLUTE。在执行 JUMP_ABSOLUTE 时，改变默认的处理方式，在这块设置一个检查，检查一个全局变量，如果全局变量被设置，则执行跳出循环的逻辑；如果未设置，执行原逻辑。

2、通过给执行程序的进程发送信号，kill -10 -p 进程号（10号信号是  SIGUSR1）。更改10号信号的信号处理函数，这个信号处理函数设置全局变量。这样的话，就可以通过 kill -10 发送信号，让循环跳出。

3、Python 虚拟机在执行多线程程序时，每个线程执行 100个 op_code 就会执行线程的切换，所以会导致子线程执行跳出循环，所以在1的基础上还需要加上判断当前的线程是否是主线程。



## 编译

```shell
./configure
make
```



## 如何使用

ps -aux | grep xxx.py 获取运行此程序的 pid

kill -10 -p 上面查到的pid 号



## 性能测试

对于纯粹的空循环，for 1 亿次，会对性能造成 **3%** 左右的损失。
